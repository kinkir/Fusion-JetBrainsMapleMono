name: Fuse Fonts (Full Icons & Weights)

on:
  push:
    branches:
      - "**"
  workflow_dispatch:
    inputs:
      FORCE:
        description: Skip checking updates & Force to fuse
        type: boolean
        default: false
        required: false

permissions:
  contents: write
  actions: read
  issues: write

env:
  FORCE: ${{ github.event.inputs.FORCE }}
  JETBRAINS_GIT_URL: ${{ github.server_url }}/JetBrains/JetBrainsMono.git
  JETBRAINS_LATEST_RELEASE_API_URL: ${{ github.api_url }}/repos/JetBrains/JetBrainsMono/releases/latest
  MAPLE_GIT_URL: ${{ github.server_url }}/subframe7536/maple-font.git
  MAPLE_LATEST_RELEASE_API_URL: ${{ github.api_url }}/repos/subframe7536/maple-font/releases/latest
  FUSION_NAME: JetBrains Maple Mono
  FUSION_ID: JetBrainsMapleMono
  FUSION_DESCRIPTION: Fused with JetBrains Mono & Maple Mono (Full Nerd Font Icons)
  FUSION_DEVELOPER: Space Time

jobs:
  check-updates:
    name: Check Updates
    runs-on: ubuntu-latest
    outputs:
      JB_VER: ${{ steps.check.outputs.JB_VER }}
      MP_VER: ${{ steps.check.outputs.MP_VER }}
    steps:
      - name: Fetch Updates
        id: check
        run: |
          JB_CUR="$(curl -s "$JETBRAINS_LATEST_RELEASE_API_URL" | jq -r ".tag_name")"
          MP_CUR="$(curl -s "$MAPLE_LATEST_RELEASE_API_URL" | jq -r ".tag_name")"
          echo "JB_VER=$JB_CUR" >> "$GITHUB_OUTPUT"
          echo "MP_VER=$MP_CUR" >> "$GITHUB_OUTPUT"

  fuse-fonts:
    name: Build All Variants
    runs-on: ubuntu-latest
    needs: [check-updates]
    strategy:
      fail-fast: false
      matrix:
        # æ„å»º 4 ç§ç»„åˆï¼š(å¸¦å›¾æ ‡/çº¯å‡€) x (å¸¦è¿å­—/æ— è¿å­—)
        NERD: [{S: NF, A: --nerd-font}, {S: XX, A: --no-nerd-font}]
        LIGA: [{S: NL}, {S: XX}]
    env:
      NERD_SUFFIX: ${{ matrix.NERD.S }}
      NERD_ARGS: ${{ matrix.NERD.A }}
      LIGA_SUFFIX: ${{ matrix.LIGA.S }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"

      - name: Build Source Fonts
        run: |
          # 1. ä¸‹è½½å¹¶æ„å»º JetBrains Mono
          git clone --depth 1 "$JETBRAINS_GIT_URL" JetBrainsMono
          cd JetBrainsMono && pip install -r requirements.txt && gftools builder "sources/config.yaml" && cd ..
          mkdir -p source-fonts/jetbrains && cp -r JetBrainsMono/fonts/ttf/* source-fonts/jetbrains/
          
          # 2. ä¸‹è½½å¹¶å…¨é‡æ„å»º Maple
          git clone --depth 1 "$MAPLE_GIT_URL" maple-font
          cd maple-font && pip install -r requirements.txt
          python build.py --normal --liga --hinted --ttf-only $NERD_ARGS
          cd ..
          
          mkdir -p source-fonts/maple
          # æ ¸å¿ƒä¿®å¤ï¼šåªæ‹·è´å½“å‰çŸ©é˜µéœ€è¦çš„æºæ–‡ä»¶ï¼Œé˜²æ­¢ find å†²çª
          if [[ "$NERD_SUFFIX" == "NF" ]]; then
            find maple-font/fonts -name "*NF*.ttf" -exec cp {} source-fonts/maple/ \;
          else
            find maple-font/fonts -name "*.ttf" ! -name "*NF*" -exec cp {} source-fonts/maple/ \;
          fi

      - name: Install Hard Tools
        run: |
          sudo apt-get -y install fontforge zip
          pip install foundrytools-cli fonttools gftools

      - name: Execute Fusion Loop
        run: |
          mkdir -p fused-final
          STYLE_LIST="Thin ThinItalic ExtraLight ExtraLightItalic Light LightItalic Regular Italic Medium MediumItalic SemiBold SemiBoldItalic Bold BoldItalic ExtraBold ExtraBoldItalic"
          
          for STYLE in $STYLE_LIST; do
            # å¼ºåŒ–æ–‡ä»¶æŸ¥æ‰¾ï¼šåœ¨é¢„ç­›é€‰åçš„æ–‡ä»¶å¤¹é‡Œå¯»æ‰¾
            MAPLE_SRC=$(find source-fonts/maple -iname "*$STYLE.ttf" | head -n 1)
            JB_SRC=$(find source-fonts/jetbrains -iname "*$STYLE.ttf" | head -n 1)
            
            if [[ -z "$MAPLE_SRC" || -z "$JB_SRC" ]]; then
               echo "âš ï¸ Skip $STYLE (missing source)"
               continue
            fi

            echo "ğŸš€ Fusing $STYLE (Maple Size: $(du -sh "$MAPLE_SRC" | cut -f1))"
            
            # æ¸…ç†è·¯å¾„èŠ‚ç‚¹
            fontforge -lang=ff -c "Open(\"$MAPLE_SRC\"); Simplify(); CorrectDirection(); RoundToInt(); Save(\"cleaned.ttf\");"
            
            fontforge "fuse_fonts.ff" "cleaned.ttf" "$JB_SRC" "$FUSION_ID-$STYLE" "$FUSION_NAME" "$FUSION_NAME $STYLE" "$STYLE" "temp.ttf" || true
            
            if [[ -f "temp.ttf" ]]; then
              # å¦‚æœæ˜¯ NL æ¨¡å¼ï¼Œæ‰§è¡Œå»è¿å­—è„šæœ¬
              if [[ "$LIGA_SUFFIX" == "NL" ]]; then
                fontforge -lang=py -c "import fontforge; f=fontforge.open('temp.ttf'); [f.removeLookup(l) for l in f.gsub_lookups]; f.generate('temp.ttf')"
              fi
              
              # 600 å­—å®½æ ¡å‡†
              ttx "temp.ttf"
              sed -i 's|<xAvgCharWidth value=".*"/>|<xAvgCharWidth value="600"/>|' "temp.ttx"
              ttx -o "temp.ttf" "temp.ttx"
              
              mv "temp.ttf" "fused-final/${FUSION_ID}-${NERD_SUFFIX}-${LIGA_SUFFIX}-${STYLE}.ttf"
              rm -f "temp.ttx" "cleaned.ttf"
            fi
          done

      - name: Package Fonts (Zip)
        run: |
          zip -j "${FUSION_ID}-${NERD_SUFFIX}-${LIGA_SUFFIX}.zip" fused-final/*.ttf

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          files: "${{ env.FUSION_ID }}-${{ env.NERD_SUFFIX }}-${{ env.LIGA_SUFFIX }}.zip"
          tag_name: "v1.0.0-FullBuild-${{ github.run_number }}"
          name: "JetBrainsMaple Full weights #${{ github.run_number }}"
          token: ${{ secrets.GITHUB_TOKEN }}
          body: |
            ## âœ… åˆå¹¶ä»»åŠ¡å®Œæˆï¼
            - **åŒ…å«å›¾æ ‡**: ${{ env.NERD_SUFFIX }}
            - **å­—å®½ç­–ç•¥**: 600 Fixed
            - **å­—é‡æ•°é‡**: å…¨éƒ¨ 16 ä¸ªæ ·å¼å·²æ‰“åŒ…è‡³ ZIP
