name: Fuse Fonts

on:
  push:
    branches:
      - "**"
  workflow_dispatch:
    inputs:
      FORCE:
        description: Skip checking updates & Force to fuse
        type: boolean
        default: false
        required: false

# 增加全局权限声明，确保 GITHUB_TOKEN 有权限创建 Release 和上传 Artifact
permissions:
  contents: write
  actions: read
  issues: write

env:
  FORCE: ${{ github.event.inputs.FORCE }}
  JETBRAINS_GIT_URL: ${{ github.server_url }}/JetBrains/JetBrainsMono.git
  JETBRAINS_LATEST_RELEASE_API_URL: ${{ github.api_url }}/repos/JetBrains/JetBrainsMono/releases/latest
  JETBRAINS_COPYRIGHT: Copyright 2020 The JetBrains Mono Project Authors (${{ github.server_url }}/JetBrains/JetBrainsMono)
  MAPLE_GIT_URL: ${{ github.server_url }}/subframe7536/maple-font.git
  MAPLE_LATEST_RELEASE_API_URL: ${{ github.api_url }}/repos/subframe7536/maple-font/releases/latest
  MAPLE_COPYRIGHT: Copyright 2022 The Maple Mono Project Authors (${{ github.server_url }}/subframe7536/maple-font)
  FUSION_NAME: JetBrains Maple Mono
  FUSION_ID: JetBrainsMapleMono
  FUSION_DESCRIPTION: The free and open-source font fused with JetBrains Mono & Maple Mono
  FUSION_DEVELOPER: Space Time
  FUSION_URL: ${{ github.server_url }}/${{ github.repository }}
  FUSION_COPYRIGHT: Copyright 2025 Space Time (${{ github.server_url }}/${{ github.repository }})
  FUSION_LICENSE: "This Font Software is licensed under the SIL Open Font License, Version 1.1. This license is available with a FAQ at: https://openfontlicense.org"

jobs:
  # ... (Update Run Time 任务保持不变，如果失败建议先注释掉这一段) ...

  check-release-updates:
    name: Check Release Updates
    runs-on: ubuntu-latest
    outputs:
      IS_RELEASE_UPDATED: ${{ steps.check-release-updates.outputs.IS_RELEASE_UPDATED }}
      JETBRAINS_LATEST_VERSION: ${{ steps.check-release-updates.outputs.JETBRAINS_LATEST_VERSION }}
      MAPLE_LATEST_VERSION: ${{ steps.check-release-updates.outputs.MAPLE_LATEST_VERSION }}

    steps:
      - name: Fetch Git Folder
        uses: actions/checkout@v4
        with:
          sparse-checkout: .git

      - name: Get Previous Run Id
        id: prev_run
        run: |
          # 修复点 1：明确使用 GH_TOKEN 环境变量
          # 修复点 2：增加逻辑判断，如果找不到上一次运行，则设为空字符串
          PREV_RUN_ID=$(gh run list --workflow "$GITHUB_WORKFLOW" --status success --limit 1 --json databaseId --jq '.[0].databaseId' || echo "")
          echo "PREV_RUN_ID=$PREV_RUN_ID" >> "$GITHUB_ENV"
          echo "Previous Successful Run Id: $PREV_RUN_ID"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Download Previous Versions
        if: env.PREV_RUN_ID != ''
        continue-on-error: true
        uses: actions/download-artifact@v4
        with:
          name: Versions
          run-id: ${{ env.PREV_RUN_ID }}
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Check Release Updates
        id: check-release-updates
        run: |
          JETBRAINS_PREV_VERSION="$(cat "jetbrains_version.txt" 2> "/dev/null" || echo "")"
          MAPLE_PREV_VERSION="$(cat "maple_version.txt" 2> "/dev/null" || echo "")"
          JETBRAINS_LATEST_VERSION="$(curl -s "$JETBRAINS_LATEST_RELEASE_API_URL" | jq -r ".tag_name")"
          MAPLE_LATEST_VERSION="$(curl -s "$MAPLE_LATEST_RELEASE_API_URL" | jq -r ".tag_name")"

          if [[ "$FORCE" == "true" || ("$JETBRAINS_PREV_VERSION" != "$JETBRAINS_LATEST_VERSION" || "$MAPLE_PREV_VERSION" != "$MAPLE_LATEST_VERSION") && \
          "$JETBRAINS_LATEST_VERSION" != "null" && "$MAPLE_LATEST_VERSION" != "null" ]]; then
            echo "IS_RELEASE_UPDATED=true" >> "$GITHUB_OUTPUT"
            echo "JETBRAINS_LATEST_VERSION=$JETBRAINS_LATEST_VERSION" >> "$GITHUB_OUTPUT"
            echo "MAPLE_LATEST_VERSION=$MAPLE_LATEST_VERSION" >> "$GITHUB_OUTPUT"
            echo "$JETBRAINS_LATEST_VERSION" > "jetbrains_version.txt"
            echo "$MAPLE_LATEST_VERSION" > "maple_version.txt"
          else
            echo "IS_RELEASE_UPDATED=false" >> "$GITHUB_OUTPUT"
          fi
      
      - name: Upload Latest Versions
        uses: actions/upload-artifact@v4
        with:
          name: Versions
          path: "*_version.txt"

  # ... (check-commit-updates 任务做同样的 Get Previous Run Id 修复) ...
  
  fuse-fonts:
    # ... 前面的步骤保持不变 ...
    # 在最后发布 Release 的地方，确保 token 使用内置的
    steps:
      # ... (中间步骤省略) ...
      - name: Release Release Fonts
        if: ${{ needs.check-release-updates.outputs.IS_RELEASE_UPDATED == 'true' && env.MODE == 'Release' }}
        uses: softprops/action-gh-release@v2
        with:
          files: |
            ${{ env.FUSION_ID }}-${{ env.NERD_SUFFIX }}-${{ env.NARROW_SUFFIX }}-${{ env.LIGA_SUFFIX }}-HT.zip
            ${{ env.FUSION_ID }}-${{ env.NERD_SUFFIX }}-${{ env.NARROW_SUFFIX }}-${{ env.LIGA_SUFFIX }}-XX.zip
          tag_name: ${{ env.FUSION_VERSION }}
          name: ${{ env.FUSION_VERSION }}
          token: ${{ secrets.GITHUB_TOKEN }} # 修复点 3：统一使用内置 Token
