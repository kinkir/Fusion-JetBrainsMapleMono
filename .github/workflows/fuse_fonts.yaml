name: Fuse Fonts (Pure English Pro - Weekly)

on:
  schedule:
    # æ¯å‘¨æ—¥ UTC 0ç‚¹ (åŒ—äº¬æ—¶é—´å‘¨æ—¥ä¸Šåˆ8ç‚¹) è‡ªåŠ¨æ£€æŸ¥å®˜æ–¹æ›´æ–°
    - cron: "0 0 * * 0"
  push:
    branches:
      - "main"
      - "master"
  workflow_dispatch:
    inputs:
      FORCE:
        description: Skip checking updates & Force to fuse
        type: boolean
        default: false
        required: false

permissions:
  contents: write
  actions: read
  issues: write

env:
  FORCE: ${{ github.event.inputs.FORCE }}
  JETBRAINS_GIT_URL: ${{ github.server_url }}/JetBrains/JetBrainsMono.git
  JETBRAINS_LATEST_RELEASE_API_URL: ${{ github.api_url }}/repos/JetBrains/JetBrainsMono/releases/latest
  MAPLE_GIT_URL: ${{ github.server_url }}/subframe7536/maple-font.git
  MAPLE_LATEST_RELEASE_API_URL: ${{ github.api_url }}/repos/subframe7536/maple-font/releases/latest
  FUSION_NAME: JetBrains Maple Mono
  FUSION_ID: JetBrainsMapleMono
  FUSION_DESCRIPTION: Pure English font fused with JetBrains Mono & Maple Mono (No Chinese)
  FUSION_DEVELOPER: Space Time

jobs:
  check-updates:
    name: Check Version Updates
    runs-on: ubuntu-latest
    outputs:
      IS_UPDATED: ${{ steps.check.outputs.IS_UPDATED }}
      JB_VER: ${{ steps.check.outputs.JB_VER }}
      MP_VER: ${{ steps.check.outputs.MP_VER }}
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          sparse-checkout: .git
          
      - name: Find Latest Successful Run
        id: find_run
        run: |
          # å¯»æ‰¾æœ€è¿‘ä¸€æ¬¡æˆåŠŸçš„æ„å»ºè®°å½• IDï¼Œç”¨äºè¯»å–æ—§ç‰ˆæœ¬å·
          ID=$(gh run list --workflow "$GITHUB_WORKFLOW" --status success --limit 1 --json databaseId --jq '.[0].databaseId' || echo "")
          echo "PREV_RUN_ID=$ID" >> "$GITHUB_ENV"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Download Previous Data
        if: env.PREV_RUN_ID != ''
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          name: Versions
          run-id: ${{ env.PREV_RUN_ID }}
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Compare Versions
        id: check
        run: |
          JB_PREV=$(cat jb_v.txt 2>/dev/null || echo "none")
          MP_PREV=$(cat mp_v.txt 2>/dev/null || echo "none")
          JB_CUR=$(curl -s "$JETBRAINS_LATEST_RELEASE_API_URL" | jq -r ".tag_name")
          MP_CUR=$(curl -s "$MAPLE_LATEST_RELEASE_API_URL" | jq -r ".tag_name")
          
          if [[ "$FORCE" == "true" || "$JB_PREV" != "$JB_CUR" || "$MP_PREV" != "$MP_CUR" ]]; then
            echo "IS_UPDATED=true" >> "$GITHUB_OUTPUT"
            echo "JB_VER=$JB_CUR" >> "$GITHUB_OUTPUT"
            echo "MP_VER=$MP_CUR" >> "$GITHUB_OUTPUT"
            echo "$JB_CUR" > jb_v.txt
            echo "$MP_CUR" > mp_v.txt
          else
            echo "IS_UPDATED=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: Versions
          path: "*_v.txt"

  fuse-fonts:
    name: Build Pure English Variants
    runs-on: ubuntu-latest
    needs: [check-updates]
    # åªæœ‰æ£€æµ‹åˆ°ç‰ˆæœ¬æ›´æ–°æˆ–æ‰‹åŠ¨å¼ºåˆ¶è§¦å‘æ—¶æ‰å¯åŠ¨æ˜‚è´µçš„æ„å»º
    if: needs.check-updates.outputs.IS_UPDATED == 'true'
    strategy:
      fail-fast: false
      matrix:
        NERD: [{S: NF, A: --nerd-font}, {S: XX, A: --no-nerd-font}]
        LIGA: [{S: NL}, {S: XX}]
    env:
      JB_VER: ${{ needs.check-updates.outputs.JB_VER }}
      MP_VER: ${{ needs.check-updates.outputs.MP_VER }}
      NERD_SUFFIX: ${{ matrix.NERD.S }}
      LIGA_SUFFIX: ${{ matrix.LIGA.S }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Build Source Fonts
        run: |
          # 1. ç¼–è¯‘ JetBrains Mono
          git clone --depth 1 "$JETBRAINS_GIT_URL" JB
          cd JB && pip install -r requirements.txt && gftools builder "sources/config.yaml" && cd ..
          mkdir -p src/jb && cp -r JB/fonts/ttf/*.ttf src/jb/

          
          # 2. ç¼–è¯‘çº¯è‹±æ–‡ç‰ˆ Maple Mono (ç¡®ä¿ç§»é™¤æ‰€æœ‰ä¸­æ–‡å‚æ•°)
          git clone --depth 1 "$MAPLE_GIT_URL" MP
          cd MP && pip install -r requirements.txt
          python build.py --normal --liga --hinted --ttf-only ${{ matrix.NERD.A }}
          cd ..
          mkdir -p src/mp
          # é€’å½’å¯»æ‰¾æ‰€æœ‰ç”Ÿæˆçš„ TTF æ–‡ä»¶å¹¶æ‰å¹³åŒ–æ‹·è´ï¼Œç¡®ä¿ 16 ä¸ªå­—é‡éƒ½èƒ½è¢«æœåˆ°
          find MP/fonts -name "*.ttf" -exec cp {} src/mp/ \;

      - name: Install Hard Tools
        run: |
          sudo apt-get -y install fontforge zip
          pip install fonttools gftools

      - name: Execute Fusion & Optimization
        run: |
          mkdir -p out
          # å®šä¹‰ 16 ä¸ªå®Œæ•´å­—é‡æ¸…å•
          STYLES="Thin ThinItalic ExtraLight ExtraLightItalic Light LightItalic Regular Italic Medium MediumItalic SemiBold SemiBoldItalic Bold BoldItalic ExtraBold ExtraBoldItalic"
          
          for S in $STYLES; do
            M_SRC=$(find src/mp -iname "*$S.ttf" | head -n 1)
            J_SRC=$(find src/jb -iname "*$S.ttf" | head -n 1)
            [[ -z "$M_SRC" || -z "$J_SRC" ]] && continue


            echo "ğŸ”¨ æ­£åœ¨å¤„ç†å­—é‡: $S"
            # è·¯å¾„å‡€åŒ–æ‰‹æœ¯ï¼šSimplify å‡å°‘èŠ‚ç‚¹ï¼Œè§£å†³ Overlap é”™è¯¯å¹¶æå‡æ¸²æŸ“æ€§èƒ½
            fontforge -lang=ff -c "Open(\"$M_SRC\"); Simplify(1,1.5); CorrectDirection(); RoundToInt(); Save(\"c.ttf\");"
            
            # æ‰§è¡Œèåˆ
            fontforge "fuse_fonts.ff" "c.ttf" "$J_SRC" "$FUSION_ID-$S" "$FUSION_NAME" "$FUSION_NAME $S" "$S" "t.ttf" || true
            
            if [[ -f "t.ttf" ]]; then
              # NL æ¨¡å¼ç‰©ç†å‰¥ç¦» GSUB è¿å­—è¡¨
              if [[ "$LIGA_SUFFIX" == "NL" ]]; then
                fontforge -lang=py -c "import fontforge; f=fontforge.open('t.ttf'); [f.removeLookup(l) for l in f.gsub_lookups]; f.generate('t.ttf')"
              fi
              
              # 600 å­—å®½æ ¡å‡† (æ ¸å¿ƒå¯¹é½ä¿éšœ)
              ttx "t.ttf"
              sed -i 's|<xAvgCharWidth value=".*"/>|<xAvgCharWidth value="600"/>|' "t.ttx"
              ttx -o "t.ttf" "t.ttx"
              
              mv "t.ttf" "out/${FUSION_ID}-${NERD_SUFFIX}-${LIGA_SUFFIX}-$S.ttf"
              rm -f "t.ttx" "c.ttf"
            fi
          done

      - name: Package ZIP
        run: zip -j "${FUSION_ID}-${NERD_SUFFIX}-${LIGA_SUFFIX}.zip" out/*.ttf

      - name: GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: "${{ env.FUSION_ID }}-${{ env.NERD_SUFFIX }}-${{ env.LIGA_SUFFIX }}.zip"
          tag_name: "v1.0.0-Build-${{ github.run_number }}"
          name: "JetBrainsMaple Pure-English #${{ github.run_number }}"
          token: ${{ secrets.GITHUB_TOKEN }}
          body: |
            ## âœ… çº¯è‹±æ–‡ç¼–ç¨‹å¢å¼ºç‰ˆæ„å»ºå®Œæˆ
            - **æ— ä¸­æ–‡æ··å…¥**ï¼šæœ¬é¡¹ç›®ä»…åŒ…å« JetBrains ä¸ Maple çš„è‹±æ–‡ã€ç¬¦å·åŠå›¾æ ‡ã€‚
            - **æºç‰ˆæœ¬**: JB(${{ env.JB_VER }}) MP(${{ env.MP_VER }})
            - **å˜ä½“è¯´æ˜**:
              - `${{ env.NERD_SUFFIX }}`: ${{ env.NERD_SUFFIX == 'NF' ? 'å« Nerd Font å›¾æ ‡ (2.3MB+)' : 'çº¯å‡€è‹±æ–‡ (300KB+)' }}
              - `${{ env.LIGA_SUFFIX }}`: ${{ env.LIGA_SUFFIX == 'NL' ? 'ç¦ç”¨è¿å­— (No Ligatures)' : 'è‡ªå¸¦è¿å­—' }}
            - **æ ¸å¿ƒä¼˜åŒ–**: å¼ºåˆ¶ 600 å­—å®½é”å®šï¼Œæ‰§è¡Œè·¯å¾„ Simplify å‡€åŒ–ã€‚

